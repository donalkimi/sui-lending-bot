#!/usr/bin/env node

/**
 * Test script to verify HTTP caching is working in the SDK
 * Run: node test-cache.js
 */

import { httpCache } from './dist/esm/index.js';

const API_URL = 'https://ws.stsui.com/api/variables';
const NUM_CALLS = 5;

async function testCache() {
  console.log('\nğŸ§ª Testing SDK HTTP Cache');
  console.log(`ğŸ“ URL: ${API_URL}`);
  console.log(`ğŸ”¢ Number of calls: ${NUM_CALLS}\n`);

  const timings = [];

  for (let i = 0; i < NUM_CALLS; i++) {
    const start = Date.now();

    try {
      await httpCache.fetchWithCache(API_URL);
      const duration = Date.now() - start;
      timings.push(duration);

      console.log(`Call ${i + 1}: ${duration}ms`);

      // Small delay between calls
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`âŒ Call ${i + 1} failed:`, error.message);
    }
  }

  console.log('\nğŸ“Š Performance Summary:');
  console.log(`   First call (cold):   ${timings[0]}ms`);
  console.log(`   Subsequent (cached): ${Math.min(...timings.slice(1))}ms - ${Math.max(...timings.slice(1))}ms`);
  console.log(`   Average cached:      ${(timings.slice(1).reduce((a, b) => a + b, 0) / (timings.length - 1)).toFixed(2)}ms`);

  const improvement = ((timings[0] - timings[timings.length - 1]) / timings[0] * 100).toFixed(1);
  console.log(`   Performance gain:    ${improvement}% faster\n`);

  // Show cache stats
  const stats = httpCache.getCacheStats();
  console.log('ğŸ’¾ Cache Statistics:');
  console.log(`   Entries: ${stats.size}`);
  console.log(`   URLs: ${stats.entries.join(', ')}\n`);
}

testCache().catch(console.error);
