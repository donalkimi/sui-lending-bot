#!/usr/bin/env node

/**
 * Test optional caching parameter in getAllMarkets()
 */

import { SuiClient } from "@mysten/sui/client";
import { AlphalendClient } from './dist/esm/index.js';

async function testCacheParameter() {
  console.log('\nðŸ§ª Testing getAllMarkets() optional cache parameter\n');
  console.log('='.repeat(80) + '\n');

  const suiClient = new SuiClient({ url: "https://fullnode.mainnet.sui.io/" });
  const client = new AlphalendClient("mainnet", suiClient);

  // Test 1: Default behavior (caching enabled)
  console.log('ðŸ“Š Test 1: Default behavior (useCache: true by default)');
  const start1 = Date.now();
  const markets1 = await client.getAllMarkets();
  const time1 = Date.now() - start1;
  console.log(`   First call:  ${time1}ms - ${markets1?.length || 0} markets`);

  const start2 = Date.now();
  const markets2 = await client.getAllMarkets();
  const time2 = Date.now() - start2;
  console.log(`   Second call: ${time2}ms (cached)\n`);

  // Test 2: Explicitly enable cache
  console.log('ðŸ“Š Test 2: Explicitly enable cache (useCache: true)');
  const start3 = Date.now();
  const markets3 = await client.getAllMarkets({ useCache: true });
  const time3 = Date.now() - start3;
  console.log(`   Call with cache: ${time3}ms (should be fast)\n`);

  // Test 3: Disable cache
  console.log('ðŸ“Š Test 3: Disable cache (useCache: false)');
  const start4 = Date.now();
  const markets4 = await client.getAllMarkets({ useCache: false });
  const time4 = Date.now() - start4;
  console.log(`   Call without cache: ${time4}ms (should be slow)\n`);

  // Test 4: Verify cache works after fresh fetch
  console.log('ðŸ“Š Test 4: Verify cache was updated after fresh fetch');
  const start5 = Date.now();
  const markets5 = await client.getAllMarkets({ useCache: true });
  const time5 = Date.now() - start5;
  console.log(`   Call with cache: ${time5}ms (should be fast again)\n`);

  // Test 5: Custom TTL
  console.log('ðŸ“Š Test 5: Custom cache TTL (10 seconds)');
  const start6 = Date.now();
  const markets6 = await client.getAllMarkets({ useCache: true, cacheTTL: 10000 });
  const time6 = Date.now() - start6;
  console.log(`   Call with custom TTL: ${time6}ms\n`);

  console.log('='.repeat(80));
  console.log('ðŸ“ˆ RESULTS SUMMARY');
  console.log('='.repeat(80));
  console.log(`Default (cached):     ${time2.toFixed(2)}ms`);
  console.log(`Explicit cache:       ${time3.toFixed(2)}ms`);
  console.log(`No cache (fresh):     ${time4.toFixed(2)}ms`);
  console.log(`After fresh (cached): ${time5.toFixed(2)}ms`);
  console.log(`Custom TTL:           ${time6.toFixed(2)}ms\n`);

  if (time2 < 100 && time3 < 100 && time5 < 100) {
    console.log('âœ… Caching is working correctly!');
  } else {
    console.log('âš ï¸  Some cached calls took longer than expected');
  }

  if (time4 > 1000) {
    console.log('âœ… Fresh fetch (no cache) took expected time');
  } else {
    console.log('âš ï¸  Fresh fetch was unexpectedly fast');
  }

  console.log('');
}

testCacheParameter()
  .then(() => process.exit(0))
  .catch(error => {
    console.error('Test failed:', error);
    process.exit(1);
  });
