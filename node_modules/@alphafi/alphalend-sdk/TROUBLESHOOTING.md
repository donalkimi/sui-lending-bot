# Troubleshooting Guide

## Common Errors and Solutions

### Error: "Cannot read properties of null (reading 'coinInfo')"

**Full Error Message:**
```
Error: Failed to initialize market data: Cannot read properties of null (reading 'coinInfo').
The SDK requires market data to function properly.
```

#### Root Cause

This error occurs in the `fetchAndCacheCoinMetadata()` method (`src/core/client.ts:122-202`) when:

1. **GraphQL API Request Fails**: The API at `https://api.alphalend.xyz/public/graphql` returns an error, times out, or is unreachable
2. **Null Response Data**: The API returns a response but `result.data.coinInfo` is `null` or `undefined`
3. **Network Issues**: Connection timeout, firewall, or proxy blocking the request

#### How the SDK Works

The AlphaLend SDK uses a lazy initialization pattern:

1. When you create an `AlphalendClient`, it doesn't immediately fetch data
2. On the first method call that needs market data (like `getUserPortfolio()`), the SDK calls `ensureInitialized()`
3. `ensureInitialized()` triggers `fetchAndCacheCoinMetadata()` which:
   - Fetches coin metadata from the GraphQL API
   - Caches it in `coinMetadataMap`
   - Updates the `LendingProtocol` instance with this data
4. The `Market` and `Position` classes use this cached metadata to look up decimals and other coin properties

#### Why This Causes Errors

The SDK code at `src/core/client.ts:155` tries to access:
```typescript
const coinInfoArray = result.data.coinInfo;
```

If `result.data` is `null` or `result.data.coinInfo` is `null`, the subsequent loop at line 158 will fail.

Similarly, the `Market` class (`src/models/market.ts:18-24`) and `Position` class (`src/models/position.ts:26-32`) both have methods that call:
```typescript
const coinMetadata = this.coinMetadataMap.get(coinType);
```

If the coin metadata wasn't cached due to initialization failure, this returns `undefined`, causing the error.

#### Solutions

##### Solution 1: Check API Connectivity

Test if the API is reachable:

```bash
# Run the diagnostic script
node examples/testApi.mjs

# Or test with curl
curl -X POST https://api.alphalend.xyz/public/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ coinInfo { symbol } }"}'
```

##### Solution 2: Add Error Handling (Recommended for SDK Users)

Wrap your SDK calls in try-catch blocks:

```typescript
import { SuiClient } from "@mysten/sui/client";
import { AlphalendClient } from "@alphafi/alphalend-sdk";

async function getPortfolio(userAddress: string) {
  const suiClient = new SuiClient({ url: "https://fullnode.mainnet.sui.io:443" });
  const client = new AlphalendClient("mainnet", suiClient);

  try {
    const portfolio = await client.getUserPortfolio(userAddress);
    return portfolio;
  } catch (error) {
    if (error instanceof Error) {
      if (error.message.includes("Failed to initialize market data")) {
        console.error("SDK initialization failed. Please check:");
        console.error("1. Network connectivity");
        console.error("2. API endpoint availability");
        console.error("3. Firewall/proxy settings");

        // Implement retry logic or fallback
        // ...
      }
    }
    throw error;
  }
}
```

##### Solution 3: Implement Retry Logic

For production applications, implement retry logic:

```typescript
async function getUserPortfolioWithRetry(
  client: AlphalendClient,
  userAddress: string,
  maxRetries = 3
) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await client.getUserPortfolio(userAddress);
    } catch (error) {
      if (attempt === maxRetries) throw error;

      console.log(`Attempt ${attempt} failed, retrying in ${attempt}s...`);
      await new Promise(resolve => setTimeout(resolve, attempt * 1000));
    }
  }
}
```

##### Solution 4: Pre-initialize the Client

Force initialization at app startup instead of on first use:

```typescript
const client = new AlphalendClient("mainnet", suiClient);

// Force initialization by fetching coin metadata
try {
  await client.fetchCoinMetadataMap();
  console.log("✅ SDK initialized successfully");
} catch (error) {
  console.error("❌ Failed to initialize SDK:", error);
  // Handle gracefully - show error to user, retry, etc.
}

// Now safe to use other methods
const portfolio = await client.getUserPortfolio(userAddress);
```

#### For AlphaLend Team: Potential SDK Improvements

1. **Better Error Messages**: The current error doesn't clearly indicate if it's a network issue, API issue, or data issue

2. **Graceful Degradation**: Consider allowing partial initialization if some coins fail

3. **Timeout Configuration**: Allow users to configure fetch timeout

4. **Fallback Data**: Provide hardcoded fallback coin metadata for critical coins

Example improvement to `fetchAndCacheCoinMetadata()`:

```typescript
private async fetchAndCacheCoinMetadata(): Promise<void> {
  try {
    const apiUrl = "https://api.alphalend.xyz/public/graphql";
    const query = `...`;

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query }),
      signal: controller.signal,
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(
        `GraphQL request failed with status ${response.status}: ${response.statusText}`
      );
    }

    const result = await response.json();

    if (!result.data) {
      throw new Error("GraphQL response missing data field");
    }

    const coinInfoArray = result.data.coinInfo;

    if (!coinInfoArray || !Array.isArray(coinInfoArray)) {
      throw new Error("GraphQL response missing or invalid coinInfo array");
    }

    // ... rest of the code
  } catch (error) {
    if (error.name === 'AbortError') {
      throw new Error(
        `Failed to initialize market data: Request timeout after 10s. ` +
        `Please check your network connection and try again.`
      );
    }

    // Provide more specific error messages
    throw new Error(
      `Failed to initialize market data: ${error instanceof Error ? error.message : "Unknown error"}. ` +
      `The SDK requires market data to function properly. ` +
      `Please check: 1) Network connectivity, 2) API availability at ${apiUrl}, ` +
      `3) Firewall/proxy settings.`
    );
  }
}
```

## Additional Resources

- Run diagnostic: `node examples/testApi.mjs`
- Example usage: `examples/getUserPortfolio.ts`
- API endpoint: https://api.alphalend.xyz/public/graphql
