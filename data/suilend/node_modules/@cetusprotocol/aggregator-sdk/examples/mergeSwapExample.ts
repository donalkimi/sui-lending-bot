import { AggregatorClient, MergeSwapParams, Env } from "../src"
import { Transaction } from "@mysten/sui/transactions"
import { SuiClient } from "@mysten/sui/client"
import BN from "bn.js"

async function mergeSwapExample() {
  // Initialize client
  const client = new AggregatorClient({
    endpoint: "https://api-sui-cloudfront.cetus.zone/router_v3",
    env: Env.Mainnet,
    signer: "0xYourWalletAddress", // Replace with your wallet address
    client: new SuiClient({ url: "https://fullnode.mainnet.sui.io" })
  })

  // 1. First, find merge swap routes
  const mergeSwapParams: MergeSwapParams = {
    target: "0xdba34672e30cb065b1f93e3ab55318768fd6fef66c15942c9f7cb846e2f900e7::usdc::USDC", // USDC
    byAmountIn: true,
    depth: 3,
    providers: ["CETUS"],
    froms: [
      {
        coinType: "0xdeeb7a4662eec9f2f3def03fb937a663dddaa2e215b8078a284d026b7946c270::deep::DEEP",
        amount: new BN("100000000")
      },
      {
        coinType: "0xce7ff77a83ea0cb6fd39bd8748e2ec89a3f41e8efdc3f4eb123e0ca37b184db2::buck::BUCK",
        amount: new BN("1000000000")
      },
      {
        coinType: "0x002::sui::SUI",
        amount: new BN("3000000000")
      }
    ]
  }

  console.log("Finding merge swap routes...")
  const routerResult = await client.findMergeSwapRouters(mergeSwapParams)
  
  if (!routerResult || routerResult.error) {
    console.error("Failed to find routes:", routerResult?.error)
    return
  }

  console.log("Routes found!")
  console.log("Total amount in:", routerResult.amountIn.toString())
  console.log("Total amount out:", routerResult.amountOut.toString())
  console.log("Number of paths:", routerResult.paths.length)

  // 2. Execute merge swap with manual input coins
  const txb = new Transaction()
  
  // Prepare input coins (you need to have these coins in your wallet)
  const inputCoins = [
    {
      coinType: "0xdeeb7a4662eec9f2f3def03fb937a663dddaa2e215b8078a284d026b7946c270::deep::DEEP",
      coin: txb.object("0xDeepCoinObjectId") // Replace with actual coin object ID
    },
    {
      coinType: "0xce7ff77a83ea0cb6fd39bd8748e2ec89a3f41e8efdc3f4eb123e0ca37b184db2::buck::BUCK", 
      coin: txb.object("0xBuckCoinObjectId") // Replace with actual coin object ID
    },
    {
      coinType: "0x002::sui::SUI",
      coin: txb.splitCoins(txb.gas, [3000000000])[0] // Use gas coin for SUI
    }
  ]

  // Execute merge swap
  const outputCoin = await client.mergeSwap({
    router: routerResult,
    inputCoins,
    slippage: 0.01, // 1% slippage
    txb,
    partner: "YourPartnerName" // Optional
  })

  console.log("Merge swap transaction built successfully!")
  
  // Transfer output to sender (optional)
  txb.transferObjects([outputCoin], client.signer)

  // Sign and execute transaction (implementation depends on your wallet integration)
  // const result = await signAndExecuteTransaction(txb)
  // console.log("Transaction executed:", result.digest)
}

async function fastMergeSwapExample() {
  // Initialize client
  const client = new AggregatorClient({
    endpoint: "https://api-sui-cloudfront.cetus.zone/router_v3",
    env: Env.Mainnet,
    signer: "0xYourWalletAddress", // Replace with your wallet address
    client: new SuiClient({ url: "https://fullnode.mainnet.sui.io" })
  })

  // 1. Find merge swap routes
  const mergeSwapParams: MergeSwapParams = {
    target: "0xdba34672e30cb065b1f93e3ab55318768fd6fef66c15942c9f7cb846e2f900e7::usdc::USDC",
    byAmountIn: true,
    depth: 3,
    froms: [
      {
        coinType: "0xdeeb7a4662eec9f2f3def03fb937a663dddaa2e215b8078a284d026b7946c270::deep::DEEP",
        amount: new BN("100000000")
      },
      {
        coinType: "0x002::sui::SUI",
        amount: new BN("2000000000")
      }
    ]
  }

  const routerResult = await client.findMergeSwapRouters(mergeSwapParams)
  
  if (!routerResult || routerResult.error) {
    console.error("Failed to find routes:", routerResult?.error)
    return
  }

  // 2. Execute fast merge swap (automatically builds input coins)
  const txb = new Transaction()
  
  await client.fastMergeSwap({
    router: routerResult,
    slippage: 0.01, // 1% slippage
    txb,
    partner: "YourPartnerName", // Optional
    payDeepFeeAmount: 1000000 // Optional: DeepBook fee if needed
  })

  console.log("Fast merge swap transaction built successfully!")
  console.log("Input coins are automatically created and output is auto-merged/transferred")
  
  // Sign and execute transaction
  // const result = await signAndExecuteTransaction(txb)
  // console.log("Transaction executed:", result.digest)
}

// Run examples
mergeSwapExample().catch(console.error)
// fastMergeSwapExample().catch(console.error)