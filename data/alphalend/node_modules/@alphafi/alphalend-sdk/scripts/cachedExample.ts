import { SuiClient } from "@mysten/sui/client";
import { AlphalendClient } from "../src/core/client.js";
import { MarketData } from "../src/core/types.js";
import { performance } from "perf_hooks";

/**
 * Example: Simple caching implementation for getAllMarkets()
 *
 * This demonstrates how to dramatically improve performance
 * by caching market data with a configurable TTL
 */

interface CacheEntry<T> {
  data: T;
  timestamp: number;
  ttl: number;
}

class CachedAlphalendClient {
  private client: AlphalendClient;
  private cache = new Map<string, CacheEntry<any>>();

  constructor(
    network: string,
    suiClient: SuiClient,
    private defaultTTL: number = 30000 // 30 seconds default
  ) {
    this.client = new AlphalendClient(network, suiClient);
  }

  /**
   * Get all markets with caching
   */
  async getAllMarkets(ttl?: number): Promise<MarketData[] | undefined> {
    const cacheKey = "getAllMarkets";
    const cacheTTL = ttl ?? this.defaultTTL;

    // Check cache
    const cached = this.cache.get(cacheKey);
    if (cached && Date.now() - cached.timestamp < cached.ttl) {
      console.log(`‚úÖ Cache HIT - Data age: ${((Date.now() - cached.timestamp) / 1000).toFixed(1)}s`);
      return cached.data;
    }

    console.log("‚ùå Cache MISS - Fetching fresh data...");

    // Fetch fresh data
    const data = await this.client.getAllMarkets();

    // Store in cache
    if (data) {
      this.cache.set(cacheKey, {
        data,
        timestamp: Date.now(),
        ttl: cacheTTL,
      });
    }

    return data;
  }

  /**
   * Clear cache
   */
  clearCache() {
    this.cache.clear();
    console.log("üóëÔ∏è  Cache cleared");
  }

  /**
   * Get cache statistics
   */
  getCacheStats() {
    const entries = Array.from(this.cache.entries());
    return entries.map(([key, value]) => ({
      key,
      age: (Date.now() - value.timestamp) / 1000,
      ttl: value.ttl / 1000,
      expired: Date.now() - value.timestamp >= value.ttl,
    }));
  }
}

async function demonstrateCaching() {
  console.log("üöÄ Demonstrating Caching Performance Improvement\n");
  console.log("=".repeat(80) + "\n");

  const network = "mainnet";
  const suiClient = new SuiClient({ url: "https://fullnode.mainnet.sui.io/" });

  // Create cached client with 60-second TTL
  const cachedClient = new CachedAlphalendClient(network, suiClient, 60000);

  // First call - cache miss
  console.log("üìä Call #1 - Initial fetch (cache is empty)");
  const start1 = performance.now();
  const markets1 = await cachedClient.getAllMarkets();
  const duration1 = performance.now() - start1;
  console.log(`‚è±Ô∏è  Duration: ${duration1.toFixed(2)}ms`);
  console.log(`üìà Markets fetched: ${markets1?.length || 0}\n`);

  // Wait a bit
  await new Promise((resolve) => setTimeout(resolve, 1000));

  // Second call - cache hit
  console.log("üìä Call #2 - Using cached data (within TTL)");
  const start2 = performance.now();
  const markets2 = await cachedClient.getAllMarkets();
  const duration2 = performance.now() - start2;
  console.log(`‚è±Ô∏è  Duration: ${duration2.toFixed(2)}ms`);
  console.log(`üìà Markets fetched: ${markets2?.length || 0}\n`);

  // Third call - still cached
  console.log("üìä Call #3 - Still using cached data");
  const start3 = performance.now();
  const markets3 = await cachedClient.getAllMarkets();
  const duration3 = performance.now() - start3;
  console.log(`‚è±Ô∏è  Duration: ${duration3.toFixed(2)}ms`);
  console.log(`üìà Markets fetched: ${markets3?.length || 0}\n`);

  // Performance comparison
  console.log("=".repeat(80));
  console.log("üìä PERFORMANCE COMPARISON");
  console.log("=".repeat(80));
  console.log(`Initial fetch (no cache):    ${duration1.toFixed(2)}ms`);
  console.log(`Cached fetch #1:             ${duration2.toFixed(2)}ms`);
  console.log(`Cached fetch #2:             ${duration3.toFixed(2)}ms`);
  console.log();
  console.log(`üí° Speedup (cached vs uncached): ${(duration1 / duration2).toFixed(0)}x faster`);
  console.log(`üí° Time saved per cached call:   ${(duration1 - duration2).toFixed(2)}ms`);
  console.log();

  // Cache statistics
  const stats = cachedClient.getCacheStats();
  console.log("üìà Cache Statistics:");
  stats.forEach((stat) => {
    console.log(`   ${stat.key}:`);
    console.log(`     Age: ${stat.age.toFixed(1)}s / TTL: ${stat.ttl}s`);
    console.log(`     Expired: ${stat.expired ? "Yes" : "No"}`);
  });

  // Clear cache demonstration
  console.log("\nüóëÔ∏è  Clearing cache...");
  cachedClient.clearCache();

  console.log("\nüìä Call #4 - After cache clear (cache miss)");
  const start4 = performance.now();
  const markets4 = await cachedClient.getAllMarkets();
  const duration4 = performance.now() - start4;
  console.log(`‚è±Ô∏è  Duration: ${duration4.toFixed(2)}ms`);
  console.log(`üìà Markets fetched: ${markets4?.length || 0}\n`);

  // Advanced: Custom TTL per call
  console.log("=".repeat(80));
  console.log("üí° ADVANCED: Custom TTL per call");
  console.log("=".repeat(80));
  console.log("\nüìä Fetching with 5-second TTL...");
  const shortTTLMarkets = await cachedClient.getAllMarkets(5000); // 5 seconds TTL
  console.log(`‚úÖ Fetched with custom TTL\n`);

  // Recommendations
  console.log("=".repeat(80));
  console.log("üí° CACHING RECOMMENDATIONS");
  console.log("=".repeat(80));
  console.log(`
1. **Production Applications**: Use 30-60 second TTL for market data
   - Market conditions don't change that rapidly
   - Users won't notice 30-second staleness
   - Massive performance improvement

2. **Real-time Applications**: Use 5-10 second TTL
   - Still provides significant caching benefits
   - Fresh enough for most use cases

3. **Admin/Analytics Dashboards**: Use 60-120 second TTL
   - Even longer caching is acceptable
   - Focus on reducing server load

4. **Implementation Tips**:
   - Clear cache on user-initiated refresh
   - Show last-update timestamp to users
   - Implement background refresh before expiry
   - Add cache warming on application startup
   - Use Redis/Memcached for distributed caching

5. **Example Usage**:
   \`\`\`typescript
   const client = new CachedAlphalendClient(network, suiClient, 30000);

   // Regular calls use 30s TTL
   const markets = await client.getAllMarkets();

   // Override TTL for specific calls
   const freshMarkets = await client.getAllMarkets(5000);

   // Clear on user action
   onUserRefresh(() => client.clearCache());
   \`\`\`
`);
}

demonstrateCaching()
  .then(() => {
    console.log("\n‚úÖ Demonstration completed");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\n‚ùå Demonstration failed:", error);
    process.exit(1);
  });
